<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WuXuxian TTRPG - Alpha Test</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1e3a5f 0%, #2d1b3d 100%);
            color: #fff;
            min-height: 100vh;
            padding: 20px;
        }

        .main-container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .container {
            text-align: center;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 60px 40px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.2);
            margin-bottom: 30px;
        }

        h1 {
            font-size: 3.5em;
            margin-bottom: 20px;
            background: linear-gradient(45deg, #ffd700, #ffed4e);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            text-shadow: 0 0 30px rgba(255, 215, 0, 0.3);
        }

        h2 {
            font-size: 1.8em;
            margin-bottom: 20px;
            color: #ffd700;
        }

        h3 {
            font-size: 1.3em;
            margin-bottom: 15px;
            color: #ffd700;
        }

        .subtitle {
            font-size: 1.3em;
            margin-bottom: 40px;
            color: #b0c4de;
            font-weight: 300;
        }

        .status {
            display: inline-block;
            padding: 10px 20px;
            background: rgba(255, 215, 0, 0.2);
            border-radius: 25px;
            margin-bottom: 40px;
            font-weight: bold;
            color: #ffd700;
            border: 2px solid #ffd700;
        }

        .buttons {
            display: flex;
            gap: 20px;
            justify-content: center;
            flex-wrap: wrap;
            margin-bottom: 40px;
        }

        .btn {
            padding: 18px 40px;
            font-size: 1.2em;
            font-weight: bold;
            border: none;
            border-radius: 50px;
            cursor: pointer;
            text-decoration: none;
            display: inline-block;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }

        .btn-small {
            padding: 10px 20px;
            font-size: 0.9em;
        }

        .btn-primary {
            background: linear-gradient(45deg, #4CAF50, #45a049);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(76, 175, 80, 0.4);
        }

        .btn-secondary {
            background: linear-gradient(45deg, #2196F3, #1976D2);
            color: white;
        }

        .btn-secondary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(33, 150, 243, 0.4);
        }

        .btn-docs {
            background: linear-gradient(45deg, #9C27B0, #7B1FA2);
            color: white;
        }

        .btn-docs:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(156, 39, 176, 0.4);
        }

        .btn-github {
            background: linear-gradient(45deg, #333, #555);
            color: white;
        }

        .btn-github:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.4);
        }

        .btn-warning {
            background: linear-gradient(45deg, #ff9800, #f57c00);
            color: white;
        }

        .btn-warning:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(255, 152, 0, 0.4);
        }

        .btn-danger {
            background: linear-gradient(45deg, #f44336, #d32f2f);
            color: white;
        }

        .features {
            text-align: left;
            margin: 40px auto;
            max-width: 600px;
        }

        .feature {
            margin: 15px 0;
            padding: 15px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            border-left: 4px solid #ffd700;
        }

        .feature-title {
            font-weight: bold;
            color: #ffd700;
            margin-bottom: 5px;
        }

        .footer {
            margin-top: 40px;
            font-size: 0.9em;
            color: #b0c4de;
        }

        .instructions {
            background: rgba(255, 215, 0, 0.1);
            border: 1px solid rgba(255, 215, 0, 0.3);
            border-radius: 10px;
            padding: 20px;
            margin: 30px 0;
            text-align: left;
        }

        .instructions h3 {
            color: #ffd700;
            margin-bottom: 15px;
        }

        .instructions code {
            background: rgba(0, 0, 0, 0.3);
            padding: 2px 8px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            color: #4CAF50;
        }

        .instructions ol, .instructions ul {
            margin-left: 20px;
            line-height: 1.8;
        }

        /* Diagnostics Panel */
        .diagnostics-panel {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.2);
            margin-bottom: 30px;
        }

        .service-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }

        .service-card {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 10px;
            padding: 20px;
            border-left: 4px solid #666;
            transition: all 0.3s ease;
        }

        .service-card.healthy {
            border-left-color: #4CAF50;
        }

        .service-card.unhealthy {
            border-left-color: #f44336;
        }

        .service-card.checking {
            border-left-color: #ff9800;
        }

        .service-name {
            font-weight: bold;
            font-size: 1.1em;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .service-status {
            font-size: 0.9em;
            color: #b0c4de;
        }

        .service-details {
            font-size: 0.85em;
            color: #888;
            margin-top: 10px;
        }

        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
        }

        .status-indicator.green {
            background: #4CAF50;
            box-shadow: 0 0 10px #4CAF50;
        }

        .status-indicator.red {
            background: #f44336;
            box-shadow: 0 0 10px #f44336;
        }

        .status-indicator.yellow {
            background: #ff9800;
            box-shadow: 0 0 10px #ff9800;
            animation: pulse 1s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* GitHub Panel */
        .github-panel {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.2);
            margin-bottom: 30px;
        }

        .github-links {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }

        .github-link {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 10px;
            padding: 15px;
            text-decoration: none;
            color: #fff;
            display: flex;
            align-items: center;
            gap: 10px;
            transition: all 0.3s ease;
        }

        .github-link:hover {
            background: rgba(255, 255, 255, 0.1);
            transform: translateY(-2px);
        }

        .github-link-icon {
            font-size: 1.5em;
        }

        .github-link-text {
            flex: 1;
        }

        .github-link-title {
            font-weight: bold;
            margin-bottom: 3px;
        }

        .github-link-desc {
            font-size: 0.85em;
            color: #b0c4de;
        }

        /* Troubleshooting Panel */
        .troubleshooting-panel {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.2);
            margin-bottom: 30px;
        }

        .trouble-item {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 10px;
            margin: 15px 0;
            overflow: hidden;
        }

        .trouble-header {
            padding: 15px 20px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: background 0.3s;
        }

        .trouble-header:hover {
            background: rgba(255, 255, 255, 0.05);
        }

        .trouble-title {
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .trouble-content {
            padding: 0 20px 20px;
            display: none;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        .trouble-content.show {
            display: block;
        }

        .trouble-content pre {
            background: rgba(0, 0, 0, 0.3);
            padding: 15px;
            border-radius: 8px;
            overflow-x: auto;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
            color: #4CAF50;
            margin: 10px 0;
        }

        /* Console Panel */
        .console-panel {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
            padding: 15px;
            margin-top: 20px;
            max-height: 300px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 0.85em;
        }

        .console-line {
            padding: 3px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }

        .console-line.info { color: #2196F3; }
        .console-line.success { color: #4CAF50; }
        .console-line.warning { color: #ff9800; }
        .console-line.error { color: #f44336; }

        .console-timestamp {
            color: #666;
            margin-right: 10px;
        }

        /* Tabs */
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .tab {
            padding: 10px 20px;
            background: rgba(255, 255, 255, 0.1);
            border: none;
            border-radius: 25px;
            color: #fff;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .tab:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .tab.active {
            background: linear-gradient(45deg, #ffd700, #ffed4e);
            color: #1e3a5f;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* API Info */
        .api-info {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 10px;
            padding: 15px;
            margin: 10px 0;
        }

        .api-endpoint {
            font-family: 'Courier New', monospace;
            color: #4CAF50;
        }

        .api-response {
            background: rgba(0, 0, 0, 0.3);
            padding: 10px;
            border-radius: 5px;
            margin-top: 10px;
            font-family: 'Courier New', monospace;
            font-size: 0.85em;
            white-space: pre-wrap;
            max-height: 200px;
            overflow-y: auto;
        }

        @media (max-width: 768px) {
            h1 {
                font-size: 2.5em;
            }
            
            .subtitle {
                font-size: 1.1em;
            }
            
            .btn {
                padding: 15px 30px;
                font-size: 1em;
            }
            
            .container {
                padding: 40px 20px;
            }
        }
    </style>
</head>
<body>
    <div class="main-container">
        <!-- Main Hero Section -->
        <div class="container">
            <h1>üéÆ WuXuxian TTRPG</h1>
            <div class="subtitle">Cultivate Your Path to Immortality</div>
            
            <div class="status" id="main-status">
                ‚è≥ Checking Services...
            </div>

            <div class="instructions">
                <h3>üöÄ Quick Start</h3>
                <ol>
                    <li>Run <code>./start-alpha.sh</code> from the repository root</li>
                    <li>Wait for all services to start (PostgreSQL, Backend, Frontend)</li>
                    <li>Click the "Enter Alpha Test" button below</li>
                    <li>When done, run <code>./stop-alpha.sh</code> to stop all services</li>
                </ol>
            </div>

            <div class="buttons">
                <a href="http://localhost:5173" class="btn btn-primary" target="_blank" rel="noopener noreferrer" id="btn-enter">
                    üéÆ Enter Alpha Test
                </a>
                <a href="http://localhost:8000/docs" class="btn btn-secondary" target="_blank" rel="noopener noreferrer">
                    üìö API Documentation
                </a>
                <button class="btn btn-warning" onclick="runDiagnostics()">
                    üîç Run Diagnostics
                </button>
                <a href="landing/index.html" class="btn btn-docs">
                    üöÄ Static Landing Page
                </a>
            </div>

            <div class="features">
                <div class="feature">
                    <div class="feature-title">‚úÖ Multi-Page Visual Novel UI</div>
                    Navigate through character sheets, wiki, SRD book, and more
                </div>
                <div class="feature">
                    <div class="feature-title">‚úÖ Character Management System</div>
                    Create and manage characters with cultivation paths, soul cores, and domain sources
                </div>
                <div class="feature">
                    <div class="feature-title">‚úÖ Combat Simulation Engine</div>
                    Monte Carlo combat simulations with 1-beat and 3-stage combat modes
                </div>
                <div class="feature">
                    <div class="feature-title">‚úÖ Knowledge Wiki & SRD</div>
                    Searchable wiki with full System Reference Document
                </div>
                <div class="feature">
                    <div class="feature-title">‚úÖ ASCII Visual Generator</div>
                    Proof-of-concept ASCII art generator for character portraits
                </div>
            </div>
        </div>

        <!-- Diagnostics Panel -->
        <div class="diagnostics-panel" id="diagnostics-panel">
            <h2>üîß Service Diagnostics</h2>
            <p style="color: #b0c4de; margin-bottom: 20px;">Real-time status of all services required for the alpha test.</p>
            
            <div class="buttons" style="margin-bottom: 20px;">
                <button class="btn btn-small btn-secondary" onclick="runDiagnostics()">üîÑ Refresh Status</button>
                <button class="btn btn-small btn-primary" onclick="runHealthChecks()">‚ù§Ô∏è Deep Health Check</button>
                <button class="btn btn-small btn-warning" onclick="exportDiagnostics()">üìã Export Report</button>
            </div>

            <div class="service-grid" id="service-grid">
                <div class="service-card checking" id="service-backend">
                    <div class="service-name">
                        <span class="status-indicator yellow"></span>
                        Backend API
                    </div>
                    <div class="service-status">Checking...</div>
                    <div class="service-details">http://localhost:8000</div>
                </div>
                <div class="service-card checking" id="service-frontend">
                    <div class="service-name">
                        <span class="status-indicator yellow"></span>
                        Frontend Dev Server
                    </div>
                    <div class="service-status">Checking...</div>
                    <div class="service-details">http://localhost:5173</div>
                </div>
                <div class="service-card checking" id="service-db">
                    <div class="service-name">
                        <span class="status-indicator yellow"></span>
                        PostgreSQL Database
                    </div>
                    <div class="service-status">Checking via API...</div>
                    <div class="service-details">localhost:5432</div>
                </div>
                <div class="service-card checking" id="service-ascii">
                    <div class="service-name">
                        <span class="status-indicator yellow"></span>
                        ASCII Art Server
                    </div>
                    <div class="service-status">Checking...</div>
                    <div class="service-details">http://localhost:3001 (optional)</div>
                </div>
            </div>

            <h3 style="margin-top: 30px;">üìä API Endpoints Test</h3>
            <div id="api-tests"></div>

            <h3 style="margin-top: 30px;">üìù Diagnostic Console</h3>
            <div class="console-panel" id="console-panel">
                <div class="console-line info">
                    <span class="console-timestamp">[--:--:--]</span>
                    Waiting for diagnostics to run...
                </div>
            </div>
        </div>

        <!-- GitHub Integration Panel -->
        <div class="github-panel">
            <h2>üêô GitHub Integration</h2>
            <p style="color: #b0c4de; margin-bottom: 20px;">Quick access to repository resources and issue tracking.</p>

            <div class="github-links">
                <a href="https://github.com/hvrryh-web/idk" class="github-link" target="_blank" rel="noopener noreferrer">
                    <span class="github-link-icon">üìñ</span>
                    <div class="github-link-text">
                        <div class="github-link-title">Repository Home</div>
                        <div class="github-link-desc">View source code and README</div>
                    </div>
                </a>
                <a href="https://github.com/hvrryh-web/idk/issues" class="github-link" target="_blank" rel="noopener noreferrer">
                    <span class="github-link-icon">üêõ</span>
                    <div class="github-link-text">
                        <div class="github-link-title">Report Issue</div>
                        <div class="github-link-desc">Found a bug? Let us know!</div>
                    </div>
                </a>
                <a href="https://github.com/hvrryh-web/idk/issues/new?template=bug_report.md" class="github-link" target="_blank" rel="noopener noreferrer">
                    <span class="github-link-icon">üìù</span>
                    <div class="github-link-text">
                        <div class="github-link-title">New Bug Report</div>
                        <div class="github-link-desc">Create a detailed bug report</div>
                    </div>
                </a>
                <a href="https://github.com/hvrryh-web/idk/issues/new?template=feature_request.md" class="github-link" target="_blank" rel="noopener noreferrer">
                    <span class="github-link-icon">üí°</span>
                    <div class="github-link-text">
                        <div class="github-link-title">Feature Request</div>
                        <div class="github-link-desc">Suggest new features</div>
                    </div>
                </a>
                <a href="https://github.com/hvrryh-web/idk/pulls" class="github-link" target="_blank" rel="noopener noreferrer">
                    <span class="github-link-icon">üîÄ</span>
                    <div class="github-link-text">
                        <div class="github-link-title">Pull Requests</div>
                        <div class="github-link-desc">View open PRs and contributions</div>
                    </div>
                </a>
                <a href="https://github.com/hvrryh-web/idk/actions" class="github-link" target="_blank" rel="noopener noreferrer">
                    <span class="github-link-icon">‚öôÔ∏è</span>
                    <div class="github-link-text">
                        <div class="github-link-title">CI/CD Actions</div>
                        <div class="github-link-desc">View build and test status</div>
                    </div>
                </a>
                <a href="https://github.com/hvrryh-web/idk/wiki" class="github-link" target="_blank" rel="noopener noreferrer">
                    <span class="github-link-icon">üìö</span>
                    <div class="github-link-text">
                        <div class="github-link-title">Wiki</div>
                        <div class="github-link-desc">Documentation and guides</div>
                    </div>
                </a>
                <a href="https://github.com/hvrryh-web/idk/releases" class="github-link" target="_blank" rel="noopener noreferrer">
                    <span class="github-link-icon">üè∑Ô∏è</span>
                    <div class="github-link-text">
                        <div class="github-link-title">Releases</div>
                        <div class="github-link-desc">Download and changelog</div>
                    </div>
                </a>
            </div>

            <div class="api-info" style="margin-top: 20px;">
                <h3>üîó Quick Issue with Diagnostics</h3>
                <p style="color: #b0c4de; margin: 10px 0;">Having trouble? Click below to create an issue with your diagnostic data attached.</p>
                <button class="btn btn-small btn-github" onclick="createGitHubIssue()">
                    üêõ Create Issue with Diagnostics
                </button>
            </div>
        </div>

        <!-- Troubleshooting Panel -->
        <div class="troubleshooting-panel">
            <h2>üîß Troubleshooting Guide</h2>
            <p style="color: #b0c4de; margin-bottom: 20px;">Common issues and their solutions. Click to expand.</p>

            <div class="trouble-item">
                <div class="trouble-header" onclick="toggleTrouble(this)">
                    <span class="trouble-title">‚ùå Backend not starting</span>
                    <span>‚ñº</span>
                </div>
                <div class="trouble-content">
                    <p><strong>Symptoms:</strong> Backend health check fails, API documentation not accessible.</p>
                    <p><strong>Solutions:</strong></p>
                    <ul>
                        <li>Check if port 8000 is already in use: <code>lsof -i :8000</code></li>
                        <li>Check backend logs: <code>cat logs/backend.log</code></li>
                        <li>Restart the backend manually:</li>
                    </ul>
                    <pre>cd backend
source .venv/bin/activate
python -m uvicorn app.main:app --reload --port 8000</pre>
                </div>
            </div>

            <div class="trouble-item">
                <div class="trouble-header" onclick="toggleTrouble(this)">
                    <span class="trouble-title">‚ùå Frontend not loading</span>
                    <span>‚ñº</span>
                </div>
                <div class="trouble-content">
                    <p><strong>Symptoms:</strong> Blank page, Vite not responding.</p>
                    <p><strong>Solutions:</strong></p>
                    <ul>
                        <li>Check if port 5173 is already in use</li>
                        <li>Check frontend logs: <code>cat logs/frontend.log</code></li>
                        <li>Restart the frontend manually:</li>
                    </ul>
                    <pre>cd frontend
npm run dev</pre>
                </div>
            </div>

            <div class="trouble-item">
                <div class="trouble-header" onclick="toggleTrouble(this)">
                    <span class="trouble-title">‚ùå Database connection failed</span>
                    <span>‚ñº</span>
                </div>
                <div class="trouble-content">
                    <p><strong>Symptoms:</strong> Database status shows unhealthy, API returns database errors.</p>
                    <p><strong>Solutions:</strong></p>
                    <ul>
                        <li>Check if Docker is running: <code>docker ps</code></li>
                        <li>Restart PostgreSQL:</li>
                    </ul>
                    <pre>cd infra
docker compose down
docker compose up -d</pre>
                    <p>If schema is missing:</p>
                    <pre>PGPASSWORD=postgres psql -h localhost -U postgres -d wuxuxian -f backend/schema.sql</pre>
                </div>
            </div>

            <div class="trouble-item">
                <div class="trouble-header" onclick="toggleTrouble(this)">
                    <span class="trouble-title">‚ùå CORS errors in browser</span>
                    <span>‚ñº</span>
                </div>
                <div class="trouble-content">
                    <p><strong>Symptoms:</strong> Browser console shows CORS policy errors.</p>
                    <p><strong>Solutions:</strong></p>
                    <ul>
                        <li>Ensure frontend is running on http://localhost:5173</li>
                        <li>Check that backend CORS is configured correctly in <code>backend/app/main.py</code></li>
                        <li>Try in incognito mode to rule out browser extensions</li>
                    </ul>
                </div>
            </div>

            <div class="trouble-item">
                <div class="trouble-header" onclick="toggleTrouble(this)">
                    <span class="trouble-title">‚ùå Services won't stop</span>
                    <span>‚ñº</span>
                </div>
                <div class="trouble-content">
                    <p><strong>Symptoms:</strong> Port already in use after running stop script.</p>
                    <p><strong>Solutions:</strong></p>
                    <pre># Find and kill processes on specific ports
lsof -ti:8000 | xargs kill -9
lsof -ti:5173 | xargs kill -9
lsof -ti:5432 | xargs kill -9

# Or use the stop script
./stop-alpha.sh</pre>
                </div>
            </div>

            <div class="trouble-item">
                <div class="trouble-header" onclick="toggleTrouble(this)">
                    <span class="trouble-title">üìã View full logs</span>
                    <span>‚ñº</span>
                </div>
                <div class="trouble-content">
                    <p><strong>Log file locations:</strong></p>
                    <ul>
                        <li>Backend: <code>logs/backend.log</code></li>
                        <li>Frontend: <code>logs/frontend.log</code></li>
                        <li>Docker: <code>docker compose -f infra/docker-compose.yml logs</code></li>
                    </ul>
                    <p><strong>Real-time log viewing:</strong></p>
                    <pre>tail -f logs/backend.log
tail -f logs/frontend.log</pre>
                </div>
            </div>
        </div>

        <!-- Footer -->
        <div class="container">
            <div class="footer">
                <p>Built with FastAPI + SQLAlchemy + React + TypeScript + PostgreSQL</p>
                <p>¬© 2024 WuXuxian TTRPG Project</p>
                <p style="margin-top: 10px;">
                    <a href="TROUBLESHOOTING.md" style="color: #ffd700;">üìñ Full Troubleshooting Guide</a> |
                    <a href="ALPHA_TEST.md" style="color: #ffd700;">üìã Alpha Test Guide</a> |
                    <a href="ARCHITECTURE.md" style="color: #ffd700;">üèóÔ∏è Architecture</a>
                </p>
            </div>
        </div>
    </div>

    <script>
        // Diagnostic data storage
        let diagnosticData = {
            timestamp: null,
            services: {},
            apiTests: {},
            errors: [],
            browser: navigator.userAgent
        };

        // Console logging
        function logToConsole(message, type = 'info') {
            const console = document.getElementById('console-panel');
            const timestamp = new Date().toLocaleTimeString();
            const line = document.createElement('div');
            line.className = `console-line ${type}`;
            line.innerHTML = `<span class="console-timestamp">[${timestamp}]</span>${message}`;
            console.appendChild(line);
            console.scrollTop = console.scrollHeight;
        }

        // Clear console
        function clearConsole() {
            document.getElementById('console-panel').innerHTML = '';
        }

        // Update service card
        function updateServiceCard(serviceId, status, message, details = null) {
            const card = document.getElementById(`service-${serviceId}`);
            if (!card) return;

            card.className = `service-card ${status}`;
            const indicator = card.querySelector('.status-indicator');
            indicator.className = `status-indicator ${status === 'healthy' ? 'green' : status === 'unhealthy' ? 'red' : 'yellow'}`;
            
            card.querySelector('.service-status').textContent = message;
            if (details) {
                card.querySelector('.service-details').textContent = details;
            }

            diagnosticData.services[serviceId] = { status, message, details };
        }

        // Check backend health
        async function checkBackend() {
            updateServiceCard('backend', 'checking', 'Checking...');
            logToConsole('Checking backend API...', 'info');
            
            try {
                const start = Date.now();
                const response = await fetch('http://localhost:8000/health', { 
                    method: 'GET',
                    mode: 'cors'
                });
                const latency = Date.now() - start;
                
                if (response.ok) {
                    const data = await response.json();
                    updateServiceCard('backend', 'healthy', `Online (${latency}ms)`, 'http://localhost:8000');
                    logToConsole(`‚úÖ Backend healthy - Response: ${JSON.stringify(data)}`, 'success');
                    return true;
                } else {
                    updateServiceCard('backend', 'unhealthy', `Error: ${response.status}`);
                    logToConsole(`‚ùå Backend returned status ${response.status}`, 'error');
                    return false;
                }
            } catch (error) {
                updateServiceCard('backend', 'unhealthy', 'Not responding');
                logToConsole(`‚ùå Backend not reachable: ${error.message}`, 'error');
                diagnosticData.errors.push({ service: 'backend', error: error.message });
                return false;
            }
        }

        // Check frontend
        async function checkFrontend() {
            updateServiceCard('frontend', 'checking', 'Checking...');
            logToConsole('Checking frontend dev server...', 'info');
            
            try {
                const start = Date.now();
                const response = await fetch('http://localhost:5173', { 
                    method: 'HEAD',
                    mode: 'no-cors'
                });
                const latency = Date.now() - start;
                
                // no-cors mode always returns opaque response, so we assume success if no error
                updateServiceCard('frontend', 'healthy', `Online (${latency}ms)`, 'http://localhost:5173');
                logToConsole('‚úÖ Frontend dev server responding', 'success');
                return true;
            } catch (error) {
                updateServiceCard('frontend', 'unhealthy', 'Not responding');
                logToConsole(`‚ùå Frontend not reachable: ${error.message}`, 'error');
                diagnosticData.errors.push({ service: 'frontend', error: error.message });
                return false;
            }
        }

        // Check database via backend API
        async function checkDatabase() {
            updateServiceCard('db', 'checking', 'Checking via API...');
            logToConsole('Checking database connection via backend...', 'info');
            
            try {
                const response = await fetch('http://localhost:8000/db-status');
                const data = await response.json();
                
                if (data.db_status === 'ok') {
                    updateServiceCard('db', 'healthy', 'Connected', 'PostgreSQL on localhost:5432');
                    logToConsole('‚úÖ Database connection successful', 'success');
                    return true;
                } else {
                    updateServiceCard('db', 'unhealthy', `Error: ${data.detail || 'Unknown'}`);
                    logToConsole(`‚ùå Database error: ${data.detail}`, 'error');
                    diagnosticData.errors.push({ service: 'database', error: data.detail });
                    return false;
                }
            } catch (error) {
                updateServiceCard('db', 'unhealthy', 'Cannot check (backend down)');
                logToConsole(`‚ö†Ô∏è Cannot check database - backend not available`, 'warning');
                return false;
            }
        }

        // Check ASCII server
        async function checkASCII() {
            updateServiceCard('ascii', 'checking', 'Checking...');
            logToConsole('Checking ASCII art server (optional)...', 'info');
            
            try {
                const response = await fetch('http://localhost:3001/health', { 
                    method: 'GET',
                    mode: 'cors'
                });
                
                if (response.ok) {
                    updateServiceCard('ascii', 'healthy', 'Online', 'http://localhost:3001');
                    logToConsole('‚úÖ ASCII server online', 'success');
                    return true;
                } else {
                    updateServiceCard('ascii', 'unhealthy', 'Error');
                    logToConsole('‚ö†Ô∏è ASCII server returned error', 'warning');
                    return false;
                }
            } catch (error) {
                updateServiceCard('ascii', 'unhealthy', 'Not running (optional)');
                logToConsole('‚ÑπÔ∏è ASCII server not running (optional service)', 'info');
                return false;
            }
        }

        // Test API endpoints
        async function testAPIEndpoints() {
            const testsContainer = document.getElementById('api-tests');
            testsContainer.innerHTML = '';
            
            const endpoints = [
                { name: 'Health Check', url: '/health', method: 'GET' },
                { name: 'Routes List', url: '/routes', method: 'GET' },
                { name: 'Debug Info', url: '/debug', method: 'GET' },
                { name: 'DB Status', url: '/db-status', method: 'GET' },
                { name: 'Recent Errors', url: '/recent-errors', method: 'GET' },
                { name: 'Characters API', url: '/api/v1/characters', method: 'GET' },
            ];

            for (const endpoint of endpoints) {
                const div = document.createElement('div');
                div.className = 'api-info';
                div.innerHTML = `
                    <strong>${endpoint.name}</strong>
                    <div class="api-endpoint">${endpoint.method} http://localhost:8000${endpoint.url}</div>
                    <div class="api-response" id="api-${endpoint.name.replace(/\s+/g, '-')}">Testing...</div>
                `;
                testsContainer.appendChild(div);

                try {
                    const response = await fetch(`http://localhost:8000${endpoint.url}`);
                    const data = await response.json();
                    const responseDiv = document.getElementById(`api-${endpoint.name.replace(/\s+/g, '-')}`);
                    responseDiv.textContent = JSON.stringify(data, null, 2);
                    responseDiv.style.color = response.ok ? '#4CAF50' : '#f44336';
                    diagnosticData.apiTests[endpoint.name] = { status: response.status, data };
                } catch (error) {
                    const responseDiv = document.getElementById(`api-${endpoint.name.replace(/\s+/g, '-')}`);
                    responseDiv.textContent = `Error: ${error.message}`;
                    responseDiv.style.color = '#f44336';
                    diagnosticData.apiTests[endpoint.name] = { error: error.message };
                }
            }
        }

        // Run full diagnostics
        async function runDiagnostics() {
            clearConsole();
            diagnosticData = {
                timestamp: new Date().toISOString(),
                services: {},
                apiTests: {},
                errors: [],
                browser: navigator.userAgent
            };
            
            logToConsole('üîç Starting diagnostics...', 'info');
            logToConsole(`Browser: ${navigator.userAgent}`, 'info');
            logToConsole(`Timestamp: ${diagnosticData.timestamp}`, 'info');
            logToConsole('‚îÄ'.repeat(50), 'info');
            
            const backendOk = await checkBackend();
            const frontendOk = await checkFrontend();
            const dbOk = await checkDatabase();
            const asciiOk = await checkASCII();
            
            logToConsole('‚îÄ'.repeat(50), 'info');
            
            // Update main status
            const mainStatus = document.getElementById('main-status');
            if (backendOk && frontendOk && dbOk) {
                mainStatus.textContent = '‚úÖ ALPHA TEST READY';
                mainStatus.style.borderColor = '#4CAF50';
                mainStatus.style.color = '#4CAF50';
                logToConsole('üéâ All critical services are running!', 'success');
            } else {
                mainStatus.textContent = '‚ö†Ô∏è SOME SERVICES UNAVAILABLE';
                mainStatus.style.borderColor = '#f44336';
                mainStatus.style.color = '#f44336';
                logToConsole('‚ö†Ô∏è Some services are not running. See above for details.', 'warning');
            }

            // Test API endpoints if backend is up
            if (backendOk) {
                logToConsole('Testing API endpoints...', 'info');
                await testAPIEndpoints();
                logToConsole('API endpoint tests complete.', 'success');
            }
            
            logToConsole('‚îÄ'.repeat(50), 'info');
            logToConsole('Diagnostics complete.', 'success');
        }

        // Deep health checks
        async function runHealthChecks() {
            clearConsole();
            logToConsole('üè• Running deep health checks...', 'info');
            
            // Basic checks
            await runDiagnostics();
            
            // Additional checks
            logToConsole('‚îÄ'.repeat(50), 'info');
            logToConsole('Running additional checks...', 'info');
            
            // Check API response times
            try {
                const endpoints = ['/health', '/routes', '/api/v1/characters'];
                for (const endpoint of endpoints) {
                    const start = Date.now();
                    await fetch(`http://localhost:8000${endpoint}`);
                    const latency = Date.now() - start;
                    logToConsole(`  ${endpoint}: ${latency}ms`, latency < 100 ? 'success' : latency < 500 ? 'warning' : 'error');
                }
            } catch (error) {
                logToConsole(`  Error during latency tests: ${error.message}`, 'error');
            }
            
            logToConsole('‚îÄ'.repeat(50), 'info');
            logToConsole('Deep health check complete.', 'success');
        }

        // Export diagnostics report
        function exportDiagnostics() {
            const report = {
                ...diagnosticData,
                exportedAt: new Date().toISOString(),
                consoleLog: Array.from(document.querySelectorAll('.console-line')).map(el => el.textContent)
            };
            
            const blob = new Blob([JSON.stringify(report, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `wuxuxian-diagnostics-${new Date().toISOString().slice(0, 10)}.json`;
            a.click();
            URL.revokeObjectURL(url);
            
            logToConsole('üìã Diagnostics report exported!', 'success');
        }

        // Escape HTML entities to prevent XSS
        function escapeHtml(text) {
            if (typeof text !== 'string') {
                text = String(text || '');
            }
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Create GitHub issue with diagnostics
        function createGitHubIssue() {
            // Escape all user-controlled data
            const escapedBrowser = escapeHtml(navigator.userAgent);
            const escapedTimestamp = escapeHtml(new Date().toISOString());
            const escapedServices = Object.entries(diagnosticData.services)
                .map(([k, v]) => `- **${escapeHtml(k)}**: ${escapeHtml(v.status)} - ${escapeHtml(v.message)}`)
                .join('\n');
            const escapedErrors = diagnosticData.errors.length > 0 
                ? diagnosticData.errors.map(e => `- ${escapeHtml(e.service)}: ${escapeHtml(e.error)}`).join('\n') 
                : 'No errors detected';

            const body = `## Environment
- **Browser**: ${escapedBrowser}
- **Timestamp**: ${escapedTimestamp}

## Service Status
${escapedServices}

## Errors
${escapedErrors}

## Steps to Reproduce
1. 
2. 
3. 

## Expected Behavior


## Actual Behavior


## Additional Context
<!-- Paste any relevant console output or screenshots here -->
`;
            
            const url = `https://github.com/hvrryh-web/idk/issues/new?title=${encodeURIComponent('[Alpha Test] Issue Report')}&body=${encodeURIComponent(body)}`;
            window.open(url, '_blank');
            logToConsole('üêõ Opened GitHub issue form with diagnostics', 'success');
        }

        // Toggle troubleshooting items
        function toggleTrouble(element) {
            const content = element.nextElementSibling;
            content.classList.toggle('show');
            element.querySelector('span:last-child').textContent = content.classList.contains('show') ? '‚ñ≤' : '‚ñº';
        }

        // Run diagnostics on page load
        document.addEventListener('DOMContentLoaded', function() {
            runDiagnostics();
        });
    </script>
</body>
</html>
