{
  "name": "Wiki Character Portrait - Detailed",
  "description": "High-quality portrait generation for Player Characters and Named Characters wiki pages",
  "version": "1.0.0",
  "workflow_type": "wiki_char_portrait",
  
  "output_specifications": {
    "resolution": {
      "width": 1024,
      "height": 1536
    },
    "format": "png",
    "transparency_option": true,
    "naming_convention": "wiki_assets/characters/{char_id}/portrait_{variant}_{seed}.png"
  },
  
  "style_reference": {
    "house_style": "Modern Manga-Illustration + RO3K",
    "primary_qualities": [
      "crisp confident ink lines",
      "smooth cel-to-soft shading hybrid",
      "high-fidelity facial features",
      "costume detail emphasis",
      "RO3K color palette"
    ]
  },
  
  "pipeline_stages": {
    "stage_1_base_generation": {
      "name": "Base Portrait Generation",
      "description": "Initial high-quality portrait generation with house style",
      "nodes": {
        "1": {
          "class_type": "CheckpointLoaderSimple",
          "inputs": {
            "ckpt_name": "{{checkpoint_name}}"
          }
        },
        "2": {
          "class_type": "CLIPTextEncode",
          "_comment": "Positive prompt with house style",
          "inputs": {
            "text": "{{positive_prompt}}",
            "clip": ["1", 1]
          }
        },
        "3": {
          "class_type": "CLIPTextEncode",
          "_comment": "Negative prompt block",
          "inputs": {
            "text": "{{negative_prompt}}",
            "clip": ["1", 1]
          }
        },
        "4": {
          "class_type": "EmptyLatentImage",
          "inputs": {
            "width": 1024,
            "height": 1536,
            "batch_size": 1
          }
        },
        "5": {
          "class_type": "KSampler",
          "inputs": {
            "seed": "{{seed}}",
            "steps": 30,
            "cfg": 7.0,
            "sampler_name": "dpmpp_2m",
            "scheduler": "karras",
            "denoise": 1.0,
            "model": ["1", 0],
            "positive": ["2", 0],
            "negative": ["3", 0],
            "latent_image": ["4", 0]
          }
        },
        "6": {
          "class_type": "VAEDecode",
          "inputs": {
            "samples": ["5", 0],
            "vae": ["1", 2]
          }
        },
        "7": {
          "class_type": "SaveImage",
          "_comment": "Intermediate save for base generation",
          "inputs": {
            "filename_prefix": "{{output_prefix}}_base",
            "images": ["6", 0]
          }
        }
      }
    },
    
    "stage_2_face_refinement": {
      "name": "Face Refinement Pass",
      "description": "Conservative face detail enhancement",
      "optional": true,
      "nodes": {
        "10": {
          "class_type": "LoadImage",
          "inputs": {
            "image": "{{stage_1_output}}"
          }
        },
        "11": {
          "class_type": "VAEEncode",
          "inputs": {
            "pixels": ["10", 0],
            "vae": ["1", 2]
          }
        },
        "12": {
          "class_type": "CLIPTextEncode",
          "_comment": "Face-focused enhancement prompt",
          "inputs": {
            "text": "{{positive_prompt}}, highly detailed face, perfect facial features, expressive detailed eyes, clean skin texture, sharp focus on face",
            "clip": ["1", 1]
          }
        },
        "13": {
          "class_type": "KSampler",
          "_comment": "Conservative refinement with low denoise",
          "inputs": {
            "seed": "{{seed}}",
            "steps": 18,
            "cfg": 6.5,
            "sampler_name": "dpmpp_2m",
            "scheduler": "karras",
            "denoise": 0.3,
            "model": ["1", 0],
            "positive": ["12", 0],
            "negative": ["3", 0],
            "latent_image": ["11", 0]
          }
        },
        "14": {
          "class_type": "VAEDecode",
          "inputs": {
            "samples": ["13", 0],
            "vae": ["1", 2]
          }
        },
        "15": {
          "class_type": "SaveImage",
          "inputs": {
            "filename_prefix": "{{output_prefix}}_refined",
            "images": ["14", 0]
          }
        }
      }
    },
    
    "stage_3_post_processing": {
      "name": "Post-Processing",
      "description": "Mild contrast, sharpen, and optional background removal",
      "optional": true,
      "nodes": {
        "20": {
          "class_type": "LoadImage",
          "inputs": {
            "image": "{{stage_2_output}}"
          }
        },
        "21": {
          "class_type": "ImageSharpen",
          "_comment": "Gentle sharpening for wiki readability",
          "inputs": {
            "image": ["20", 0],
            "sharpen_radius": 1,
            "sigma": 0.5,
            "alpha": 0.3
          }
        },
        "22": {
          "class_type": "ImageContrastAdjust",
          "_comment": "Mild contrast enhancement",
          "inputs": {
            "image": ["21", 0],
            "contrast": 1.05,
            "brightness": 1.0
          }
        },
        "23": {
          "class_type": "SaveImage",
          "_comment": "Final output",
          "inputs": {
            "filename_prefix": "{{output_prefix}}_final",
            "images": ["22", 0]
          }
        }
      }
    },
    
    "stage_4_background_removal": {
      "name": "Background Removal (Optional)",
      "description": "Remove background for transparent PNG output",
      "optional": true,
      "enabled_by_default": false,
      "nodes": {
        "30": {
          "class_type": "LoadImage",
          "inputs": {
            "image": "{{stage_3_output}}"
          }
        },
        "31": {
          "class_type": "RemBGSession",
          "_comment": "Background removal using rembg if available",
          "inputs": {
            "model": "u2net_human_seg"
          }
        },
        "32": {
          "class_type": "RemoveBackground",
          "inputs": {
            "image": ["30", 0],
            "rembg_session": ["31", 0]
          }
        },
        "33": {
          "class_type": "SaveImage",
          "_comment": "Transparent output",
          "inputs": {
            "filename_prefix": "{{output_prefix}}_transparent",
            "images": ["32", 0]
          }
        }
      }
    }
  },
  
  "prompt_templates": {
    "positive_base": "masterpiece, best quality, highly detailed illustration, modern manga illustration style, professional character art, crisp confident ink lines, clean linework, minimal sketchiness, smooth controlled shading, cel-to-soft shading hybrid, tasteful gradients, high-fidelity facial features, detailed expressive eyes, clean skin rendering, costume detail emphasis, embroidered trims, brocade patterns, intricate accessories, Romance of Three Kingdoms aesthetic, Han dynasty inspired, wuxia xianxia fantasy, rich saturated colors, controlled highlights, strong silhouette readability, studio lighting, professional game illustration, AAA character art quality, sharp focus, high contrast, vibrant yet tasteful color palette, three kingdoms color palette, rich reds, blacks, jade teal accents, gold trim",
    
    "positive_portrait_composition": "character portrait, bust shot, upper body portrait, 3/4 view facing slightly left, centered composition, clean gradient background, studio backdrop, dramatic rim lighting from upper left, high detail face, expressive eyes, dignified expression, hands not visible or simplified",
    
    "negative_base": "lowres, bad anatomy, bad hands, missing fingers, extra fingers, extra digits, fewer digits, cropped, worst quality, low quality, normal quality, jpeg artifacts, signature, watermark, username, logo, text, typography, cover text, title text, blurry, out of focus, photoreal skin pores, overly realistic, hyper realistic, oversharp AI artifacts, noise, dithering, deformed, anime chibi, super deformed, cartoonish, heavy painterly smears, oil painting texture, impressionist blur, overexposed bloom, lens flare, chromatic aberration, western comic style, american cartoon, disney style, 3d render, cgi, uncanny valley, duplicate, multiple views on single canvas, split image, nsfw, nude, suggestive, revealing clothing, background clutter, busy background, noisy background"
  },
  
  "character_prompt_template": {
    "format": "{positive_base}, {positive_portrait_composition}, {character_name}, {character_description}, {visual_traits}, {outfit_description}, {faction_colors}",
    "variables": {
      "character_name": "Character's display name",
      "character_description": "Brief character role/archetype description",
      "visual_traits": "Hair color, eye color, distinctive features",
      "outfit_description": "Clothing and costume details",
      "faction_colors": "Faction-specific color accents"
    }
  },
  
  "lora_integration": {
    "enabled": false,
    "house_style_lora": {
      "name": "wiki_house_style.safetensors",
      "weight": 0.7,
      "required": false,
      "fallback_behavior": "continue_without_lora",
      "placeholder_path": "models/loras/wiki_house_style.safetensors"
    },
    "lora_loader_node": {
      "class_type": "LoraLoader",
      "inputs": {
        "model": ["1", 0],
        "clip": ["1", 1],
        "lora_name": "{{lora_name}}",
        "strength_model": "{{lora_weight}}",
        "strength_clip": "{{lora_weight}}"
      }
    }
  },
  
  "ip_adapter_integration": {
    "enabled": false,
    "description": "IP-Adapter style reference support for style consistency",
    "settings": {
      "style_strength": 0.5,
      "structure_preservation": 0.8,
      "max_reference_images": 3
    },
    "ip_adapter_node": {
      "class_type": "IPAdapter",
      "_comment": "IP-Adapter for style reference only - not composition copying",
      "inputs": {
        "model": ["1", 0],
        "ipadapter": ["ip_loader", 0],
        "image": "{{style_reference_image}}",
        "weight": "{{style_strength}}",
        "weight_type": "style transfer"
      }
    }
  },
  
  "metadata_output": {
    "enabled": true,
    "sidecar_format": "json",
    "fields": [
      "workflow_name",
      "workflow_version",
      "character_id",
      "character_name",
      "prompt_positive",
      "prompt_negative",
      "seed",
      "checkpoint_model",
      "lora_used",
      "generation_timestamp",
      "output_resolution"
    ]
  },
  
  "quality_requirements": {
    "minimum_resolution": {"width": 1024, "height": 1536},
    "consistent_framing": "bust/half-body, 3/4 view",
    "hands_policy": "off-frame or simplified to reduce failure modes",
    "background": "clean gradient or studio backdrop",
    "thumbnail_readability": "must be recognizable at 128x192 thumbnail size"
  }
}
