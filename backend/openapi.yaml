openapi: 3.0.3
info:
  title: WuXuxian TTRPG Backend API
  version: 0.3.0
  description: >
    Backend API for a xianxia-inspired TTRPG system with HERO-style power
    building, Fate-card-driven Soul Core Techniques, and Monte Carlo combat simulations.

servers:
  - url: https://api.example.com/api/v1
    description: Production

paths:
  /characters:
    get:
      summary: List characters
      tags: [Characters]
      parameters:
        - in: query
          name: type
          schema:
            $ref: '#/components/schemas/CharacterType'
          required: false
        - in: query
          name: limit
          schema:
            type: integer
            minimum: 1
            default: 50
        - in: query
          name: offset
          schema:
            type: integer
            minimum: 0
            default: 0
      responses:
        '200':
          description: List of characters
          content:
            application/json:
              schema:
                type: object
                properties:
                  items:
                    type: array
                    items:
                      $ref: '#/components/schemas/CharacterRead'
                  total:
                    type: integer
    post:
      summary: Create character
      tags: [Characters]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CharacterCreate'
      responses:
        '201':
          description: Created character
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CharacterRead'

  /characters/{characterId}:
    get:
      summary: Get character
      tags: [Characters]
      parameters:
        - in: path
          name: characterId
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Character
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CharacterRead'
        '404':
          description: Not found
    patch:
      summary: Update character
      tags: [Characters]
      parameters:
        - in: path
          name: characterId
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CharacterUpdate'
      responses:
        '200':
          description: Updated character
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CharacterRead'
    delete:
      summary: Delete character
      tags: [Characters]
      parameters:
        - in: path
          name: characterId
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '204':
          description: Deleted

  /techniques:
    get:
      summary: List techniques
      tags: [Techniques]
      parameters:
        - in: query
          name: tier
          schema:
            $ref: '#/components/schemas/TechniqueTier'
        - in: query
          name: archetype
          schema:
            type: string
        - in: query
          name: axis
          schema:
            $ref: '#/components/schemas/TechniqueAxis'
      responses:
        '200':
          description: List of techniques
          content:
            application/json:
              schema:
                type: object
                properties:
                  items:
                    type: array
                    items:
                      $ref: '#/components/schemas/TechniqueRead'
                  total:
                    type: integer
    post:
      summary: Create technique
      tags: [Techniques]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/TechniqueCreate'
      responses:
        '201':
          description: Created technique
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TechniqueRead'

  /techniques/{techniqueId}:
    get:
      summary: Get technique
      tags: [Techniques]
      parameters:
        - in: path
          name: techniqueId
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Technique
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TechniqueRead'
        '404':
          description: Not found
    patch:
      summary: Update technique
      tags: [Techniques]
      parameters:
        - in: path
          name: techniqueId
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/TechniqueUpdate'
      responses:
        '200':
          description: Updated technique
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TechniqueRead'

  /fate/death-cards:
    get:
      summary: List Hero's Death cards
      tags: [FateCards]
      responses:
        '200':
          description: List of death cards
          content:
            application/json:
              schema:
                type: object
                properties:
                  items:
                    type: array
                    items:
                      $ref: '#/components/schemas/DeathCard'
    post:
      summary: Create Hero's Death card
      tags: [FateCards]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/DeathCardCreate'
      responses:
        '201':
          description: Created death card
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/DeathCard'

  /fate/body-cards:
    get:
      summary: List Re:Life Body cards
      tags: [FateCards]
      responses:
        '200':
          description: List of body cards
          content:
            application/json:
              schema:
                type: object
                properties:
                  items:
                    type: array
                    items:
                      $ref: '#/components/schemas/BodyCard'
    post:
      summary: Create Re:Life Body card
      tags: [FateCards]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/BodyCardCreate'
      responses:
        '201':
          description: Created body card
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/BodyCard']]

  /fate/seed-cards:
    get:
      summary: List Seed cards
      tags: [FateCards]
      responses:
        '200':
          description: List of seed cards
          content:
            application/json:
              schema:
                type: object
                properties:
                  items:
                    type: array
                    items:
                      $ref: '#/components/schemas/SeedCard'
    post:
      summary: Create Seed card
      tags: [FateCards]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/SeedCardCreate'
      responses:
        '201':
          description: Created seed card
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SeedCard'

  /effect-modules:
    get:
      summary: List effect modules
      tags: [EffectModules]
      responses:
        '200':
          description: List of effect modules
          content:
            application/json:
              schema:
                type: object
                properties:
                  items:
                    type: array
                    items:
                      $ref: '#/components/schemas/EffectModule'
    post:
      summary: Create effect module
      tags: [EffectModules]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/EffectModuleCreate'
      responses:
        '201':
          description: Created effect module
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/EffectModule']]

  /boss-templates:
    get:
      summary: List boss templates
      tags: [BossTemplates]
      responses:
        '200':
          description: List of boss templates
          content:
            application/json:
              schema:
                type: object
                properties:
                  items:
                    type: array
                    items:
                      $ref: '#/components/schemas/BossTemplate'
    post:
      summary: Create boss template
      tags: [BossTemplates]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/BossTemplateCreate'
      responses:
        '201':
          description: Created boss template
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/BossTemplate']]

  /boss-templates/{templateId}:
    get:
      summary: Get boss template
      tags: [BossTemplates]
      parameters:
        - in: path
          name: templateId
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Boss template
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/BossTemplate'
        '404':
          description: Not found
    patch:
      summary: Update boss template
      tags: [BossTemplates]
      parameters:
        - in: path
          name: templateId
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/BossTemplateUpdate'
      responses:
        '200':
          description: Updated boss template
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/BossTemplate']]

  /simulations/configs:
    post:
      summary: Create simulation config
      tags: [Simulations]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/SimulationConfigCreate'
      responses:
        '201':
          description: Created simulation config
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SimulationConfigRead']]

  /simulations/configs/{configId}:
    get:
      summary: Get simulation config
      tags: [Simulations]
      parameters:
        - in: path
          name: configId
          schema:
            type: string
            format: uuid
          required: true
      responses:
        '200':
          description: Simulation config
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SimulationConfigRead'
        '404':
          description: Not found

  /simulations/runs:
    post:
      summary: Run simulation
      tags: [Simulations]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                config_id:
                  type: string
                  format: uuid
      responses:
        '200':
          description: Simulation run started and completed synchronously
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SimulationRunRead']]

  /simulations/runs/{runId}:
    get:
      summary: Get simulation run
      tags: [Simulations]
      parameters:
        - in: path
          name: runId
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Simulation run
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SimulationRunRead'
        '404':
          description: Not found

  /power-builder/innate:
    post:
      summary: Build a Soul Core (Innate) Technique for a character
      tags: [PowerBuilder]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/InnateBuildRequest'
      responses:
        '201':
          description: Created innate technique (and optional character update)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/InnateBuildResponse']]

components:
  schemas:
    CharacterType:
      type: string
      enum: [PC, Boss, NPC]

    SpeedBand:
      type: string
      enum: [Normal, Fast, SuperFast]

    TechniqueTier:
      type: string
      enum: [Basic, Std, Maj, Innate]

    TechniqueAxis:
      type: string
      enum: [Body, Mind, Soul, Mixed]

    FateColour:
      type: string
      enum: [Red, Blue, Green, Black, Gold]

    FateAspect:
      type: string
      enum: [Body, Mind, Soul]

    CharacterCoreStats:
      type: object
      properties:
        bod:
          type: integer
        mnd:
          type: integer
        sol:
          type: integer
      required: [bod, mnd, sol]

    CharacterAetherStats:
      type: object
      properties:
        ae_max:
          type: number
        ae_reg:
          type: number
        strain_cap:
          type: number
      required: [ae_max, ae_reg, strain_cap]

    CharacterHPStats:
      type: object
      properties:
        thp_max:
          type: number
        php_max:
          type: number
        mshp_max:
          type: number
      required: [php_max, mshp_max]

    CharacterDefence:
      type: object
      properties:
        dr:
          type: number
          description: Damage reduction (0â€“1)
        guard:
          type: object
          properties:
            base_charges:
              type: integer
            prr:
              type: integer
            mrr:
              type: integer
            srr:
              type: integer
          required: [base_charges, prr, mrr, srr]
      required: [dr, guard]

    CharacterSpeed:
      type: object
      properties:
        spd_raw:
          type: integer
        spd_band:
          $ref: '#/components/schemas/SpeedBand']]

    CharacterFateProfile:
      type: object
      properties:
        death_card_id:
          type: string
          nullable: true
        body_card_id:
          type: string
          nullable: true
        seed_card_ids:
          type: array
          items:
            type: string
        soul_thesis:
          type: string
      required: [seed_card_ids]

    CharacterTechniqueProfile:
      type: object
      properties:
        basic_ids:
          type: array
          items:
            type: string
        std_ids:
          type: array
          items:
            type: string
        maj_ids:
          type: array
          items:
            type: string]

    CharacterCreate:
      type: object
      properties:
        name:
          type: string
        type:
          $ref: '#/components/schemas/CharacterType'
        core_stats:
          $ref: '#/components/schemas/CharacterCoreStats'
        aether:
          $ref: '#/components/schemas/CharacterAetherStats'
        hp:
          $ref: '#/components/schemas/CharacterHPStats'
        defence:
          $ref: '#/components/schemas/CharacterDefence'
        speed:
          type: object
          properties:
            spd_raw:
              type: integer
        fate_profile:
          $ref: '#/components/schemas/CharacterFateProfile'
      required: [name, type, core_stats, aether, hp, defence]

    CharacterUpdate:
      type: object
      properties:
        name:
          type: string
        core_stats:
          $ref: '#/components/schemas/CharacterCoreStats'
        aether:
          $ref: '#/components/schemas/CharacterAetherStats'
        hp:
          $ref: '#/components/schemas/CharacterHPStats'
        defence:
          $ref: '#/components/schemas/CharacterDefence'
        speed:
          $ref: '#/components/schemas/CharacterSpeed'
        fate_profile:
          $ref: '#/components/schemas/CharacterFateProfile'
        technique_profile:
          $ref: '#/components/schemas/CharacterTechniqueProfile']]

    CharacterRead:
      type: object
      properties:
        id:
          type: string
          format: uuid
        name:
          type: string
        type:
          $ref: '#/components/schemas/CharacterType'
        sc:
          type: integer
        seq_lvl:
          type: integer
        realm_lvl:
          type: integer
        core_stats:
          $ref: '#/components/schemas/CharacterCoreStats'
        aether:
          $ref: '#/components/schemas/CharacterAetherStats'
        hp:
          $ref: '#/components/schemas/CharacterHPStats'
        defence:
          $ref: '#/components/schemas/CharacterDefence'
        speed:
          $ref: '#/components/schemas/CharacterSpeed'
        fate_profile:
          $ref: '#/components/schemas/CharacterFateProfile'
        technique_profile:
          $ref: '#/components/schemas/CharacterTechniqueProfile']]

    TechniqueDamageRouting:
      type: object
      properties:
        to_thp:
          type: number
        to_php:
          type: number
        to_mshp:
          type: number]

    TechniqueBuildMeta:
      type: object
      properties:
        magic_rank:
          type: integer
        budget:
          type: number
        base_cost_discounted:
          type: number
        active_cost:
          type: number
        real_cost:
          type: number
        modules:
          type: array
          items:
            type: object
            properties:
              id:
                type: string
              rank:
                type: integer
        advantages:
          type: array
          items:
            type: string
        limitations:
          type: array
          items:
            type: string
        seed_colours:
          type: array
          items:
            $ref: '#/components/schemas/FateColour'
        death_card:
          type: string
        body_card:
          type: string]

    TechniqueCreate:
      type: object
      properties:
        id:
          type: string
        name:
          type: string
        tier:
          $ref: '#/components/schemas/TechniqueTier'
        archetype:
          type: string
        axis:
          $ref: '#/components/schemas/TechniqueAxis'
        target_pool:
          type: string
          enum: [PHP, MSHP, mixed]
        base_offrank_bias:
          type: number
        base_damage:
          type: number
        ae_cost:
          type: number
        self_strain:
          type: number
        damage_routing:
          $ref: '#/components/schemas/TechniqueDamageRouting'
        boss_strain_on_hit:
          type: number
        dr_debuff:
          type: number
        ally_shield:
          type: object
        build_meta:
          $ref: '#/components/schemas/TechniqueBuildMeta']]

    TechniqueUpdate:
      type: object
      allOf:
        - $ref: '#/components/schemas/TechniqueCreate']]

    TechniqueRead:
      type: object
      allOf:
        - $ref: '#/components/schemas/TechniqueCreate']]

    DeathCard:
      type: object
      properties:
        id:
          type: string
        name:
          type: string
        summary:
          type: string
        tags:
          type: array
          items:
            type: string
        mechanical_hooks:
          type: object]

    DeathCardCreate:
      type: object
      properties:
        name:
          type: string
        summary:
          type: string
        tags:
          type: array
          items:
            type: string
        mechanical_hooks:
          type: object
      required: [name]

    BodyCard:
      type: object
      properties:
        id:
          type: string
        name:
          type: string
        summary:
          type: string
        stat_mods:
          type: object
        spd_mod:
          type: integer
        archetype_hint:
          type: string
        mechanical_hooks:
          type: object]

    BodyCardCreate:
      type: object
      properties:
        name:
          type: string
        summary:
          type: string
        stat_mods:
          type: object
        spd_mod:
          type: integer
        archetype_hint:
          type: string
        mechanical_hooks:
          type: object]

    SeedCard:
      type: object
      properties:
        id:
          type: string
        colour:
          $ref: '#/components/schemas/FateColour'
        aspect:
          $ref: '#/components/schemas/FateAspect'
        keywords:
          type: array
          items:
            type: string
        mechanical_bias:
          type: object]

    SeedCardCreate:
      type: object
      properties:
        colour:
          $ref: '#/components/schemas/FateColour'
        aspect:
          $ref: '#/components/schemas/FateAspect'
        keywords:
          type: array
          items:
            type: string
        mechanical_bias:
          type: object]

    EffectModule:
      type: object
      properties:
        id:
          type: string
        name:
          type: string
        base_cost_per_rank:
          type: number]

    EffectModuleCreate:
      type: object
      properties:
        id:
          type: string
        name:
          type: string
        base_cost_per_rank:
          type: number
      required: [id, name, base_cost_per_rank]

    BossTemplate:
      type: object
      properties:
        id:
          type: string
        name:
          type: string
        rank:
          type:
