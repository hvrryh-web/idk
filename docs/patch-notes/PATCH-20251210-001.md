# Patch ID: PATCH-20251210-001

**Date**: 2025-12-10
**Category**: FEATURE
**Status**: ACTIVE

## Summary
Combat UI Implementation - Initial release of player-controlled combat interface for Wuxianxia VN + TTRPG hybrid.

## Changes

### Frontend Components
- **NEW**: `frontend/src/components/combat/CombatView.tsx` - Main combat container with turn management
- **NEW**: `frontend/src/components/combat/CombatantCard.tsx` - Character display with resource bars
- **NEW**: `frontend/src/components/combat/TurnIndicator.tsx` - Phase and round display
- **NEW**: `frontend/src/components/combat/TechniqueSelector.tsx` - Technique selection with cost preview
- **NEW**: `frontend/src/components/combat/QuickActionPanel.tsx` - Quick action buttons
- **NEW**: `frontend/src/components/combat/CombatLog.tsx` - Action history feed
- **NEW**: `frontend/src/components/combat/ActionPreview.tsx` - Cost preview with Blood/Fate/Stain warnings
- **MODIFIED**: `frontend/src/App.tsx` - Added `/combat/:encounterId` route
- **MODIFIED**: `frontend/src/types.ts` - Added combat-related types
- **MODIFIED**: `frontend/src/api.ts` - Added combat API functions

### Backend Routes
- **NEW**: `backend/app/api/routes/combat.py` - Player combat endpoints
- **NEW**: `backend/app/simulation/player_combat.py` - Player turn handling logic
- **MODIFIED**: `backend/app/api/routes/__init__.py` - Registered combat routes

### Documentation
- **NEW**: `docs/patch-notes/` - Patch notes system with ID tagging
- **NEW**: `docs/COMBAT_UI_UX_FLOW.md` - Detailed UX flow documentation
- **NEW**: `docs/COMBAT_UI_TEST_PLAN.md` - Testing checklist and test cases

## Affected Systems

### Combat System
- Three-stage combat (Fast SPD → Major Actions → Slow SPD)
- Turn-based player control
- Resource management (THP, AE, Strain, Guard)
- Technique execution with previews

### UI System
- Combat view with real-time state updates
- Resource cost preview before action confirmation
- Visual feedback for available/unavailable actions
- Combat log with action history

### Data Models
- Extended CombatState for player-controlled combat
- Action preview data structure
- Cost track warnings (Blood/Fate/Stain)

## Resource Cost Preview Features

The combat UI displays resource costs and warnings before action execution:

### Action Energy (AE) Preview
- Shows technique AE cost
- Disables techniques when insufficient AE
- Visual indicator for affordable vs unaffordable actions

### Strain Tracking
- Displays self-strain cost for techniques
- Shows cumulative strain effect
- Warning when approaching strain limits

### Cost Track Warnings
- **Blood Track**: Warnings for techniques that mark Blood cost
- **Fate Track**: Warnings for destiny-altering effects
- **Stain Track**: Warnings for corrupting or forbidden techniques
- Color-coded severity indicators

### Preview Display Format
```
Technique: Gu Fangs
Cost: 8 AE
Self-Strain: +1
Blood Track: +1 mark (Glass Cannon stance)
Estimated Damage: 32 THP (after DR)
```

## UX Flow Summary

### 3-6 Step Combat Exchange
1. **Combat Start**: Narrative hook → transition to combat view
2. **Turn Indicator**: Show current phase (Quick Action Stage 1 → Major Action → Quick Action Stage 3)
3. **Action Selection**: Player selects technique or quick action with cost preview
4. **Target Selection**: Click enemy portrait to target
5. **Execute & Feedback**: Animation + combat log update + resource updates
6. **Resolution**: Enemy turn → round end → repeat or combat end

## Manual Test Checklist

See `docs/COMBAT_UI_TEST_PLAN.md` for detailed testing procedures.

### Quick Smoke Tests
1. ✓ Load combat view with valid encounter
2. ✓ Display character portraits with resource bars
3. ✓ Select technique and see cost preview
4. ✓ Execute technique and see resource updates
5. ✓ View combat log with action history
6. ✓ Complete combat round and see AE regeneration

## Fallback UI Features

### Autosave Support
- Combat state saved after each action
- Can resume interrupted combats
- State includes full action history

### Deterministic Replay
- Combat log can be exported
- Actions can be replayed from saved state
- Useful for debugging and balance testing

## Testing Notes

### Unit Tests
- `backend/tests/test_player_combat.py` - Player action execution
- `frontend/src/test/combat/CombatView.test.tsx` - Component rendering

### Integration Tests
- Full combat flow from start to resolution
- API endpoint testing for combat actions
- Resource tracking validation

### Expected Behavior
- Techniques become disabled when AE insufficient
- Resource bars update immediately after actions
- Combat log shows clear action descriptions
- Phase indicator updates each stage
- Enemy AI responds after player turn

## Migration Notes

### No Breaking Changes
This is a new feature addition. Existing simulation endpoints remain unchanged.

### Optional Feature
Combat UI is opt-in. Monte Carlo simulations continue to work as before.

### Data Compatibility
Uses existing Character, Technique, and BossTemplate models. No schema changes required.

## Related Patches
- None (initial release)

## Future Enhancements
- WebSocket support for real-time multiplayer
- Advanced animations and visual effects
- Condition tooltips with detailed effects
- Combat replay viewer
- Spectator mode for AI simulations
