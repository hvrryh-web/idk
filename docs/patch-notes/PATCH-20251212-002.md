# Patch ID: PATCH-20251212-002

**Date**: 2025-12-12
**Category**: SYSTEM
**Status**: ACTIVE

## Summary

Architecture Decision Records (ADR) Integration - Establishes ADR-0001 through ADR-0005 as the canonical resolution engine, stat model, contest roles, skill/tag system, and technique tag taxonomy for the Unified SRD.

## Changes

### New Files

#### Architecture Decision Records (`docs/adr/`)
- **NEW**: `docs/adr/README.md` - ADR index and guidelines
- **NEW**: `docs/adr/ADR-0001-core-resolution-engine.md` - Core Resolution Engine (Opposed d20 + Rank Dice, ±4 DoS)
- **NEW**: `docs/adr/ADR-0002-canonical-stat-model.md` - Canonical Stat Model and Pillar→Defense Mapping
- **NEW**: `docs/adr/ADR-0003-bonus-composition-contest-roles.md` - Bonus Composition and Contest Roles
- **NEW**: `docs/adr/ADR-0004-skill-layer-tagging.md` - Skill Layer and Tagging System
- **NEW**: `docs/adr/ADR-0005-technique-tag-taxonomy.md` - Technique Tag Taxonomy and Validation Rules

#### Backend Implementation
- **NEW**: `backend/app/core/resolution_engine.py` - Core Resolution Engine implementation per ADR-0001
- **NEW**: `backend/tests/test_resolution_engine.py` - 58 unit tests for resolution engine

### Modified Files

#### Backend Updates
- **UPDATED**: `backend/app/core/srd_constants.py`
  - Version bumped to 0.4.0
  - Added ADR-0002 canonical stat model (6 root stats, CL/SL/SCL)
  - Added ADR-0002 pillar→defense/resilience mappings
  - Added ADR-0002 rank derivation (MartialRank=CL, SorceryRank=SL)
  - Added ADR-0003 contest types and trait selection logic
  - Added ADR-0004 skill enum, pillar mappings, and descriptions
  - Added ADR-0004 tag types and invoke mechanics

## ADR Summary

### ADR-0001: Core Resolution Engine
- **Status**: Accepted
- **Key Decisions**:
  - Every check = Actor Total vs Opposition Total
  - Total = d20 + Bonus + KeptRankDie
  - Rank dice: X = 1 + floor(Rank/2), Y = min(12, 4 + 2*Rank)
  - DoS computed with K=4 (locked), range [-4, +4]
  - Defender wins ties (DoS = 0)
  - Optional but canonical: Nat 20/1 shift ±1

### ADR-0002: Canonical Stat Model
- **Status**: Accepted
- **Key Decisions**:
  - 6 root stats: Body, Mind, Soul, Control, Fate, Spirit
  - CL = floor((Body + Mind + Soul) / 3)
  - SL = floor((Control + Fate + Spirit) / 3)
  - SCL = CL + SL
  - Pillar mapping: Violence→Body, Influence→Soul, Revelation→Mind
  - MartialRank = CL, SorceryRank = SL
  - Cap formula: 4×SCL with PDB modifiers

### ADR-0003: Bonus Composition and Contest Roles
- **Status**: Accepted
- **Key Decisions**:
  - Bonus = PillarTrait + SkillBonus + EdgeBonus + SituationalMods
  - Contest type table defines Actor/Opposition traits
  - Status quo rule: DoS=0 means no state change
  - TN mode as first-class citizen

### ADR-0004: Skill Layer and Tagging
- **Status**: Accepted
- **Key Decisions**:
  - 12 canonical skills (4 per pillar)
  - Skill rating 0-6, cap = SCL + 2
  - Cost: 1 SCP per +1 rating
  - 5 tag types: Technique, Gear, Character, Scene, Complication
  - Invoke for Reroll or +3 (costs 1 meta-currency)
  - Max 2 invokes per check

### ADR-0005: Technique Tag Taxonomy
- **Status**: Accepted
- **Key Decisions**:
  - Three tag classes: Descriptor, Extra, Flaw
  - v1.0 canonical tag list with 40+ allowed tags
  - VirtualRanks rule for cap validation
  - Scene/Complication tag creation/consumption aligned with Fate Create Advantage
  - Max 3 Extras + 3 Flaws per technique
  - Geometry exclusivity (Area/Aura/Multiattack) requires cost-linked Flaw

## Affected Systems

### Documentation
- ADR directory created as canonical rules reference
- SRD now references ADRs for core mechanics

### Backend
- Resolution engine fully implemented and tested
- SRD constants updated with ADR-aligned models

### Future Integration Required
- SRD_UNIFIED.md needs full alignment pass with ADRs
- Frontend needs resolution engine integration
- Combat engine needs ADR-0001 integration
- Technique builder needs ADR-0005 validation

## Technical Specifications

### Resolution Engine Functions

```python
# Rank dice
get_rank_dice_pool(rank: int) -> Tuple[int, int]
roll_rank_dice(rank: int) -> int

# DoS computation
compute_dos(margin: int, k: int = 4) -> int
apply_nat_shift(base_dos: int, actor_d20: int, opp_d20: int) -> int

# Full resolution
resolve_opposed(actor_bonus, actor_rank, opp_bonus, opp_rank) -> ResolutionResult
resolve_tn(actor_bonus, actor_rank, tn) -> ResolutionResult
```

### Test Coverage

| Module | Tests | Status |
|--------|-------|--------|
| resolution_engine.py | 58 | ✅ Passing |
| srd_constants.py | 30 | ✅ Passing |

## Testing Notes

### Resolution Engine Tests
- Rank dice mapping for Rank 0-5+ verified
- DoS banding for all margin ranges verified
- Nat 20/1 shift combinations verified
- Tie behavior (defender wins) verified
- Clamping to [-4, +4] verified

### Running Tests
```bash
cd backend
python -m pytest tests/test_resolution_engine.py -v
python -m pytest tests/test_srd_constants.py -v
```

## Migration Notes

### No Breaking Changes
This patch adds new files and extends existing modules. No existing functionality is removed or changed.

### Terminology Updates
- "Core roll" → "Resolution check" (per ADR-0001)
- 9 primary stats → 6 root stats (per ADR-0002)
- Influence→Mind → Influence→Soul (per ADR-0002)
- Revelation→Soul → Revelation→Mind (per ADR-0002)

### Future Migration
- SRD text will be updated in a follow-up patch to use ADR terminology consistently
- Combat engine will be refactored to use resolution_engine functions

## Related Patches
- PATCH-20251212-001 (Unified SRD Alpha v0.3) - Base SRD this patch extends
- PATCH-20251210-001 (Combat UI Implementation) - Combat systems to be aligned

## Document Status

**Version**: Alpha v0.4
**Completeness**: 60% (ADR foundation complete, SRD alignment pending)
**Next Steps**:
- Full SRD alignment pass with ADR cross-references
- Combat engine integration with resolution_engine
- Frontend tag/skill UI components
